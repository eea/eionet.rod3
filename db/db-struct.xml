<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
     You can run this change log on your database as many times as you want, it will ignore the
     changes that are already applied. It also means that you can't modify an existing revision.
     Always add to the end.

     Use the maven goals: liquibase:update, liquibase:status or liquibase:changelogSync
      Potentially with -Dliquibase.dropFirst=true
 -->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet author="roug" id="rev-1">
        <comment>Access control lists</comment>
        <createTable tableName="ACLS">
            <column name="ACL_ID" type="INT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column defaultValue="" name="ACL_NAME" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="PARENT_NAME" type="VARCHAR(100)"/>
            <column defaultValue="" name="OWNER" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="DESCRIPTION" type="VARCHAR(255)"/>
        </createTable>

        <createIndex indexName="ACL_NAME" tableName="ACLS" unique="true">
            <column name="ACL_NAME"/>
            <column name="PARENT_NAME"/>
        </createIndex>

    </changeSet>

    <changeSet author="roug" id="rev-2">
        <createTable tableName="ACL_ROWS">
            <column defaultValueNumeric="0" name="ACL_ID" type="INT">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="object" name="TYPE" type="enum('object','doc','dcc')">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="user" name="ENTRY_TYPE" type="enum('owner','user','localgroup','other','foreign','unauthenticated','authenticated','mask')">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="PRINCIPAL" type="CHAR(16)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="PERMISSIONS" type="CHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueNumeric="0" name="STATUS" type="INT(1)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="ACL_ID, TYPE, ENTRY_TYPE, PRINCIPAL, STATUS" tableName="ACL_ROWS"/>
		<modifySql dbms="h2">
    		<replace replace="ENUM('object','doc','dcc')" with="VARCHAR(6)"/>
    		<replace replace="ENUM('owner','user','localgroup','other','foreign','unauthenticated','authenticated','mask')" with="VARCHAR(50)"/>
		</modifySql> 
    </changeSet>

    <changeSet author="roug" id="rev-3">
        <createTable tableName="HLP_AREA">
            <column defaultValue="" name="AREA_ID" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="SCREEN_ID" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="DESCRIPTION" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="LANGUAGE" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="HTML" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="" name="MD5" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="400" name="POPUP_WIDTH" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column defaultValue="400" name="POPUP_LENGTH" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <!--
        <modifySql dbms="mysql">
             <replace replace="LONGTEXT" with="text"/>
         </modifySql>
        -->
       <addPrimaryKey columnNames="AREA_ID, SCREEN_ID, LANGUAGE" tableName="HLP_AREA"/>

    </changeSet>

    <changeSet author="roug" id="rev-4">
        <createTable tableName="HLP_SCREEN">
            <column defaultValue="" name="SCREEN_ID" type="VARCHAR(100)">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="DESCRIPTION" type="TEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <!--
        <modifySql dbms="mysql">
             <replace replace="LONGTEXT" with="text"/>
        </modifySql>
         -->
    </changeSet>


    <changeSet author="roug" id="rev-5">
        <createTable tableName="T_CLIENT">
            <column name="PK_CLIENT_ID" type="INT(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="CLIENT_NAME" type="varchar(255)"/>
            <column name="CLIENT_ACRONYM" type="varchar(100)"/>
            <column name="CLIENT_URL" type="varchar(255)"/>
            <column name="CLIENT_ADDRESS" type="varchar(255)"/>
            <column name="CLIENT_EMAIL" type="varchar(255)"/>
            <column name="DESCRIPTION" type="TEXT"/>
            <column name="POSTAL_CODE" type="varchar(100)"/>
            <column name="CITY" type="varchar(255)"/>
            <column name="COUNTRY" type="varchar(255)"/>
            <column name="CLIENT_SHORT_NAME" type="varchar(100)"/>
        </createTable>
   </changeSet>


    <changeSet author="roug" id="rev-6">
        <createTable tableName="T_CLIENT_LNK">
            <column defaultValueNumeric="0" name="FK_CLIENT_ID" type="INT(10) unsigned">
                <constraints nullable="false" />
            </column>
            <column defaultValueNumeric="0" name="FK_OBJECT_ID" type="INT(10) unsigned">
                <constraints nullable="false" />
            </column>
            <column defaultValue="" name="TYPE" type="char(1)">
                <constraints nullable="false" />
            </column>
            <column defaultValue="M" name="STATUS" type="enum('M','C')">
                <constraints nullable="false" />
            </column>
        </createTable>

       <addPrimaryKey tableName="T_CLIENT_LNK" columnNames="FK_CLIENT_ID,FK_OBJECT_ID,TYPE,STATUS"/>
       <modifySql dbms="h2">
    		<replace replace="ENUM('M','C')" with="VARCHAR(1)"/>
    	</modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-7">
        <comment>Delivery information from Content Registry to the reporting</comment>
        <createTable tableName="T_DELIVERY">
            <column name="RA_URL" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="TITLE" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="UPLOAD_DATE" type="DATE">
                <constraints nullable="true"/>
            </column>
            <column name="DELIVERY_URL" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
            <column name="FORMAT" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
            <column name="FK_RA_ID" type="INT(10) unsigned">
                <constraints nullable="true"/>
            </column>
            <column name="FK_SPATIAL_ID" type="INT(10) unsigned">
                <constraints nullable="true"/>
            </column>
            <column name="COVERAGE" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
            <column name="COVERAGE_NOTE" type="TEXT"/>
            <column name="STATUS" type="INT(1)">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <createIndex indexName="FK_RA_ID" tableName="T_DELIVERY" unique="false">
            <column name="FK_RA_ID"/>
        </createIndex>

        <createIndex indexName="FK_SPATIAL_ID" tableName="T_DELIVERY" unique="false">
            <column name="FK_SPATIAL_ID"/>
        </createIndex>
   </changeSet>


    <changeSet author="roug" id="rev-9">
        <createTable tableName="T_HELP">
            <column name="PK_HELP_ID" type="varchar(50)" defaultValue="">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="HELP_TITLE" type="varchar(255)"/>
            <column name="HELP_TEXT" type="TEXT"/>
        </createTable>
   </changeSet>


    <changeSet author="roug" id="rev-10">
        <createTable tableName="T_HISTORIC_DEADLINES">
            <column name="FK_RA_ID" type="INT(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="DEADLINE" type="DATE" defaultValueDate="0000-00-00">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addPrimaryKey tableName="T_HISTORIC_DEADLINES" columnNames="FK_RA_ID,DEADLINE"/>

   </changeSet>


    <changeSet author="roug" id="rev-11">
        <createTable tableName="T_HISTORY">
            <column name="PK_HISTORY_ID" type="INT(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="ITEM_ID" type="INT(10)"/>
            <column name="ITEM_TYPE" type="CHAR(1)"/>
            <column name="ACTION_TYPE" type="CHAR(1)"/>
            <column name="LOG_TIME" type="DATETIME"/>
            <column name="USER" type="VARCHAR(100)"/>
            <column name="DESCRIPTION" type="TEXT"/>
        </createTable>
   </changeSet>


    <changeSet author="roug" id="rev-12">
        <createTable tableName="T_INDICATOR">
          <column name="PK_INDICATOR_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="FK_RA_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="NUMBER" type="varchar(100)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="TITLE" type="varchar(255)"/>
          <column name="URL" type="varchar(255)"/>
          <column name="OWNER" type="varchar(255)"/>
        </createTable>
   </changeSet>


    <changeSet author="roug" id="rev-13">
        <createTable tableName="T_INFO_LNK">
          <column name="FK_RA_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="FK_INFO_ID" type="char(1)" defaultValue="">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="T_INFO_LNK" columnNames="FK_RA_ID,FK_INFO_ID"/>
   </changeSet>


    <changeSet author="roug" id="rev-14">
        <createTable tableName="T_ISSUE">
          <column name="PK_ISSUE_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="ISSUE_NAME" type="varchar(100)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="FK_DD_GUID" type="int(10) unsigned"/>
          <column name="DD_URL" type="varchar(255)"/>
        </createTable>
   </changeSet>


    <changeSet author="roug" id="rev-15">
        <createTable tableName="T_LOOKUP">
          <column name="C_TERM" type="varchar(100)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="CATEGORY" type="enum('1','2','C','P','L','S','F','UT','ST','I','DGS')" defaultValue="P">
                <constraints nullable="false"/>
            </column>
          <column name="C_VALUE" type="char(1)"/>
        </createTable>

        <addPrimaryKey tableName="T_LOOKUP" columnNames="C_TERM,CATEGORY"/>
        <modifySql dbms="h2">
    		<replace replace="ENUM('1','2','C','P','L','S','F','UT','ST','I','DGS')" with="VARCHAR(3)"/>
    	</modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-16">
        <createTable tableName="T_OBLIGATION">
          <column name="PK_RA_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="FK_SOURCE_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="VALID_SINCE" type="date"/>
          <column name="TITLE" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="FORMAT_NAME" type="varchar(100)"/>
          <column name="REPORT_FORMAT_URL" type="varchar(255)"/>
          <column name="REPORT_FREQ_DETAIL" type="varchar(50)"/>
          <column name="REPORTING_FORMAT" type="text"/>
          <column name="DATE_COMMENTS" type="varchar(255)"/>
          <column name="LAST_UPDATE" type="date"/>
          <column name="TERMINATE" type="enum('Y','N')" defaultValue="N">
                <constraints nullable="false"/>
            </column>
          <column name="REPORT_FREQ" type="varchar(25)"/>
          <column name="COMMENT" type="text"/>
          <column name="RESPONSIBLE_ROLE" type="varchar(255)"/>
          <column name="NEXT_DEADLINE" type="date"/>
          <column name="FIRST_REPORTING" type="date"/>
          <column name="REPORT_FREQ_MONTHS" type="int(3)"/>
          <column name="NEXT_REPORTING" type="varchar(255)"/>
          <column name="VALID_TO" type="date"/>
          <column name="FK_DELIVERY_COUNTRY_IDS" type="varchar(255)"/>
          <column name="NEXT_DEADLINE2" type="date"/>
          <column name="RM_NEXT_UPDATE" type="date"/>
          <column name="RM_VERIFIED" type="date"/>
          <column name="RM_VERIFIED_BY" type="varchar(50)"/>
          <column name="LAST_HARVESTED" type="datetime"/>
          <column name="LOCATION_PTR" type="varchar(255)"/>
          <column name="LOCATION_INFO" type="varchar(255)"/>
          <column name="LEGAL_MORAL" type="enum('L','M','V')" defaultValue="L"/>
          <column name="FK_CLIENT_ID" type="int(10) unsigned"/>
          <column name="DESCRIPTION" type="text"/>
          <column name="RESPONSIBLE_ROLE_SUF" type="int(1)" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
          <column name="NATIONAL_CONTACT" type="varchar(255)"/>
          <column name="NATIONAL_CONTACT_URL" type="varchar(255)"/>
          <column name="COORDINATOR_ROLE" type="varchar(255)"/>
          <column name="COORDINATOR_ROLE_SUF" type="int(1)" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
          <column name="COORDINATOR" type="varchar(255)"/>
          <column name="COORDINATOR_URL" type="varchar(255)"/>
          <column name="PARAMETERS" type="text"/>
          <column name="VALIDATED_BY" type="text"/>
          <column name="EEA_PRIMARY" type="int(1)" defaultValueNumeric="0"/>
          <column name="EEA_CORE" type="int(1)" defaultValueNumeric="0"/>
          <column name="FLAGGED" type="int(1)" defaultValueNumeric="0"/>
          <column name="AUTHORITY" type="varchar(255)"/>
          <column name="OVERLAP_URL" type="varchar(255)"/>
          <column name="DPSIR_D" type="enum('yes','no')"/>
          <column name="DPSIR_P" type="enum('yes','no')"/>
          <column name="DPSIR_S" type="enum('yes','no')"/>
          <column name="DPSIR_I" type="enum('yes','no')"/>
          <column name="DPSIR_R" type="enum('yes','no')"/>
          <column name="DATA_USED_FOR" type="varchar(255)"/>
          <column name="DATA_USED_FOR_URL" type="varchar(255)"/>
          <column name="CONTINOUS_REPORTING" type="enum('yes','no')"/>
        </createTable>
       	 <createIndex tableName="T_OBLIGATION" indexName="FK_SOURCE_ID">
          <column name="FK_SOURCE_ID"/>
        </createIndex>
        <modifySql dbms="h2">
     		<replace replace="ENUM('Y', 'N')" with="VARCHAR(1)"/>
     		<replace replace="ENUM('yes', 'no')" with="VARCHAR(3)"/>
     		<replace replace="ENUM('L', 'M','V')" with="VARCHAR(1)"/>
		</modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-17">
        <createTable tableName="T_RAISSUE_LNK">
          <column name="FK_ISSUE_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="FK_RA_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="T_RAISSUE_LNK" columnNames="FK_ISSUE_ID,FK_RA_ID"/>
   </changeSet>


    <changeSet author="roug" id="rev-18">
        <createTable tableName="T_RASPATIAL_LNK">
          <column name="FK_SPATIAL_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="FK_RA_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="VOLUNTARY" type="enum('Y','N')" defaultValue="Y">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="T_RASPATIAL_LNK" columnNames="FK_SPATIAL_ID,FK_RA_ID,VOLUNTARY"/>
        <modifySql dbms="h2">
     		<replace replace="ENUM('Y', 'N')" with="VARCHAR(1)"/>
		</modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-19">
        <comment>Role information from DIRECTORY</comment>
        <createTable tableName="T_ROLE">
          <column name="ROLE_NAME" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="ROLE_EMAIL" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="ROLE_URL" type="text"/>
          <column name="ROLE_ID" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="ROLE_MEMBERS_URL" type="varchar(255)"/>
          <column name="LAST_HARVESTED" type="datetime"/>
          <column name="STATUS" type="int(1)" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="T_ROLE" columnNames="ROLE_ID,STATUS"/>
   </changeSet>

    <changeSet author="roug" id="rev-21">
        <createTable tableName="T_SOURCE">
          <column name="PK_SOURCE_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="FK_TYPE_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="SOURCE_CODE" type="varchar(50)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="TITLE" type="text">
                <constraints nullable="false"/>
            </column>
          <column name="CELEX_REF" type="varchar(255)"/>
          <column name="LEGAL_NAME" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="URL" type="text"/>
          <column name="SECRETARIAT" type="text"/>
          <column name="SECRETARIAT_URL" type="varchar(255)"/>
          <column name="ABSTRACT" type="text"/>
          <column name="EC_ACCESSION" type="date"/>
          <column name="EC_ENTRY_INTO_FORCE" type="date"/>
          <column name="DRAFT" type="enum('Y','N')"/>
          <column name="COMMENT" type="text"/>
          <column name="LAST_MODIFIED" type="date"/>
          <column name="ISSUED_BY" type="text"/>
          <column name="VALID_FROM" type="date"/>
          <column name="ALIAS" type="text"/>
          <column name="ISSUED_BY_URL" type="varchar(255)"/>
          <column name="FK_CLIENT_ID" type="int(10) unsigned"/>
          <column name="LAST_UPDATE" type="timestamp">
                <constraints nullable="false"/>
            </column>
          <column name="RM_NEXT_UPDATE" type="date"/>
          <column name="RM_VERIFIED" type="date"/>
          <column name="RM_VERIFIED_BY" type="varchar(50)"/>
          <column name="GEOGRAPHIC_SCOPE" type="varchar(255)"/>
          <column name="DGENV_REVIEW" type="char(1)"/>
          <column name="RM_VALIDATED_BY" type="varchar(50)"/>
        </createTable>

        <sql dbms="mysql,mariadb">ALTER TABLE T_SOURCE CHANGE COLUMN LAST_UPDATE
            LAST_UPDATE timestamp NOT NULL default CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP</sql>

        <createIndex tableName="T_SOURCE" indexName="FK_TYPE_ID">
          <column name="FK_TYPE_ID"/>
        </createIndex>
        <createIndex tableName="T_SOURCE" indexName="LEGAL_NAME">
          <column name="LEGAL_NAME"/>
        </createIndex>
         <modifySql dbms="h2">
     		<replace replace="ENUM('Y', 'N')" with="VARCHAR(1)"/>
    	</modifySql>
   </changeSet>

    <changeSet author="roug" id="rev-21m" dbms="mysql,mariadb">
        <preConditions onFail="MARK_RAN">
            <not><indexExists indexName="FT_TITLE"/></not>
        </preConditions>
        <createIndex tableName="T_SOURCE" indexName="FT_TITLE">
          <column name="TITLE(1)"/>
        </createIndex>
        <createIndex tableName="T_SOURCE" indexName="TITLE">
          <column name="TITLE(20)"/>
        </createIndex>
        <createIndex tableName="T_SOURCE" indexName="FT_ALIAS">
          <column name="ALIAS(1)"/>
        </createIndex>
        <createIndex tableName="T_SOURCE" indexName="ALIAS">
          <column name="ALIAS(20)"/>
        </createIndex>
   </changeSet>


    <changeSet author="roug" id="rev-22">
        <createTable tableName="T_SOURCE_CLASS">
          <column name="PK_CLASS_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="CLASSIFICATOR" type="varchar(20)"/>
          <column name="CLASS_NAME" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="NEW" type="tinyint(3) unsigned" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
        </createTable>
   </changeSet>


    <changeSet author="roug" id="rev-23">
        <createTable tableName="T_SOURCE_LNK">
          <column name="PK_SOURCE_LNK_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="FK_SOURCE_CHILD_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="CHILD_TYPE" type="enum('S','C')" defaultValue="S">
                <constraints nullable="false"/>
            </column>
          <column name="FK_SOURCE_PARENT_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="PARENT_TYPE" type="enum('S','C')" defaultValue="S">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex tableName="T_SOURCE_LNK" indexName="FK_SOURCE_CHILD_ID_2" unique="true">
          <column name="FK_SOURCE_CHILD_ID"/>
          <column name="CHILD_TYPE"/>
          <column name="FK_SOURCE_PARENT_ID"/>
          <column name="PARENT_TYPE"/>
        </createIndex>
        <createIndex tableName="T_SOURCE_LNK" indexName="FK_SOURCE_CHILD_ID">
          <column name="FK_SOURCE_CHILD_ID"/>
          <column name="CHILD_TYPE"/>
        </createIndex>
        <createIndex tableName="T_SOURCE_LNK" indexName="FK_SOURCE_PARENT_ID">
          <column name="FK_SOURCE_PARENT_ID"/>
          <column name="PARENT_TYPE"/>
        </createIndex>
         <modifySql dbms="h2">
     		<replace replace="ENUM('S', 'C')" with="VARCHAR(1)"/>
		</modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-24">
        <createTable tableName="T_SOURCE_TYPE">
          <column name="PK_TYPE_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="TYPE" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="NEW" type="tinyint(3) unsigned" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex tableName="T_SOURCE_TYPE" indexName="TYPE">
          <column name="TYPE"/>
        </createIndex>
   </changeSet>


    <changeSet author="roug" id="rev-25">
        <createTable tableName="T_SPATIAL" remarks="SpatialCoverage">
          <column name="PK_SPATIAL_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="SPATIAL_NAME" type="varchar(100)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="SPATIAL_TYPE" type="char(1)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="FK_DD_GUID" type="int(10) unsigned"/>
          <column name="DD_URL" type="varchar(255)"/>
          <column name="SPATIAL_TWOLETTER" type="varchar(2)"/>
          <column name="SPATIAL_ISMEMBERCOUNTRY" type="enum('Y','N')"/>
        </createTable>
        <createIndex tableName="T_SPATIAL" indexName="SPATIAL_TYPE">
          <column name="SPATIAL_TYPE"/>
        </createIndex>
        <modifySql dbms="h2">
             <replace replace="ENUM('Y', 'N')" with="VARCHAR(1)"/>
        </modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-26">
        <createTable tableName="T_SPATIAL_HISTORY">
          <column name="FK_SPATIAL_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="FK_RA_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="VOLUNTARY" type="enum('Y','N')" defaultValue="N"/>
          <column name="START_DATE" type="date"/>
          <column name="END_DATE" type="date"/>
          <column name="PK_SPATIAL_HISTORY_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
          </column>
            
        </createTable>
         <modifySql dbms="h2">
             <replace replace="ENUM('Y', 'N')" with="VARCHAR(1)"/>
        </modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-27">
        <createTable tableName="T_UNDO">
          <column name="undo_time" type="bigint(20)" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="tab" type="varchar(32)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="col" type="varchar(32)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="operation" type="enum('I','D','U','A','L','K','O','UN','UD','UDD','T','ACL')" defaultValue="I">
                <constraints nullable="false"/>
            </column>
          <column name="quotes" type="enum('n','y')"/>
          <column name="p_key" type="enum('n','y')"/>
          <column name="value" type="blob"/>
          <column name="sub_trans_nr" type="int(11)" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="show_object" type="enum('n','y')"/>
        </createTable>
        <addPrimaryKey tableName="T_UNDO" columnNames="undo_time,tab,col,operation,sub_trans_nr"/>
        <createIndex tableName="T_UNDO" indexName="col">
          <column name="col"/>
        </createIndex>
        <modifySql dbms="h2">
             <replace replace="ENUM('I','D','U','A','L','K','O','UN','UD','UDD','T','ACL')" with="VARCHAR(3)"/>
             <replace replace="ENUM('n','y')" with="VARCHAR(1)"/>
        </modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-28">
        <createTable tableName="X_ACTIVITY" remarks="Reporting Activity">
          <column name="PK_RA_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="FK_RO_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="FK_SOURCE_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="VALID_SINCE" type="date"/>
          <column name="TITLE" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="FORMAT_NAME" type="varchar(100)"/>
          <column name="REPORT_FORMAT_URL" type="varchar(255)"/>
          <column name="REPORT_FREQ_DETAIL" type="varchar(50)"/>
          <column name="REPORTING_FORMAT" type="text"/>
          <column name="DATE_COMMENTS" type="varchar(255)"/>
          <column name="LAST_UPDATE" type="date"/>
          <column name="TERMINATE" type="enum('Y','N')" defaultValue="N">
                <constraints nullable="false"/>
            </column>
          <column name="REPORT_FREQ" type="varchar(25)"/>
          <column name="COMMENT" type="text"/>
          <column name="RESPONSIBLE_ROLE" type="varchar(255)"/>
          <column name="NEXT_DEADLINE" type="date"/>
          <column name="FIRST_REPORTING" type="date"/>
          <column name="REPORT_FREQ_MONTHS" type="int(3)"/>
          <column name="NEXT_REPORTING" type="varchar(255)"/>
          <column name="VALID_TO" type="date"/>
          <column name="FK_DELIVERY_COUNTRY_IDS" type="varchar(255)"/>
          <column name="NEXT_DEADLINE2" type="date"/>
          <column name="RM_NEXT_UPDATE" type="date"/>
          <column name="RM_VERIFIED" type="date"/>
          <column name="RM_VERIFIED_BY" type="varchar(50)"/>
          <column name="LAST_HARVESTED" type="datetime"/>
          <column name="LOCATION_PTR" type="varchar(255)"/>
          <column name="LOCATION_INFO" type="varchar(255)"/>
        </createTable>
        <createIndex tableName="X_ACTIVITY" indexName="FK_REPORTING_ID">
          <column name="FK_RO_ID"/>
        </createIndex>
        <modifySql dbms="h2">
             <replace replace="ENUM('Y','N')" with="VARCHAR(1)"/>
        </modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-29">
        <createTable tableName="X_CLIENT_LNK">
          <column name="FK_CLIENT_ID" type="int(10) unsigned"/>
          <column name="FK_OBJECT_ID" type="int(10) unsigned"/>
          <column name="TYPE" type="char(1)"/>
          <column name="STATUS" type="char(1)"/>
        </createTable>
   </changeSet>


    <changeSet author="roug" id="rev-30">
        <createTable tableName="X_PARAMETER">
          <column name="PK_PARAMETER_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="PARAMETER_NAME" type="varchar(100)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="FK_GROUP_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="FK_DD_GUID" type="int(10) unsigned"/>
          <column name="DD_URL" type="varchar(255)"/>
          <column name="NEW" type="tinyint(3) unsigned" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex tableName="X_PARAMETER" indexName="FK_GROUP_ID">
          <column name="FK_GROUP_ID"/>
        </createIndex>
        <createIndex tableName="X_PARAMETER" indexName="PARAMETER_NAME">
          <column name="PARAMETER_NAME"/>
        </createIndex>
   </changeSet>


    <changeSet author="roug" id="rev-31">
        <createTable tableName="X_PARAMETER_LNK">
          <column name="PK_PARAMETER_LNK_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="FK_PARAMETER_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="PARAMETER_UNIT" type="varchar(50)"/>
          <column name="FK_RA_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="FK_UNIT_ID" type="int(10) unsigned"/>
        </createTable>
        <createIndex tableName="X_PARAMETER_LNK" indexName="FK_PARAMETER_ID">
          <column name="FK_PARAMETER_ID"/>
        </createIndex>
        <createIndex tableName="X_PARAMETER_LNK" indexName="XP_RA_ID">
          <column name="FK_RA_ID"/>
        </createIndex>
   </changeSet>


    <changeSet author="roug" id="rev-32">
        <createTable tableName="X_PARAM_GROUP" remarks="GROUP">
          <column name="PK_GROUP_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="GROUP_NAME" type="varchar(100)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="FK_DD_GUID" type="int(10) unsigned"/>
          <column name="DD_URL" type="varchar(255)"/>
          <column name="GROUP_TYPE" type="enum('C','S')" defaultValue="C">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <modifySql dbms="h2">
             <replace replace="ENUM('C','S')" with="VARCHAR(1)"/>
        </modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-33">
        <createTable tableName="X_REPORTING">
          <column name="PK_RO_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="FK_SOURCE_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="LEGAL_MORAL" type="enum('L','M','V')" defaultValue="L">
                <constraints nullable="false"/>
            </column>
          <column name="LAST_UPDATE" type="timestamp">
                <constraints nullable="false"/>
            </column>
          <column name="ALIAS" type="varchar(255)"/>
          <column name="REPORT_TO" type="text"/>
          <column name="VALID_FROM" type="date"/>
          <column name="RECOGNIZED" type="enum('Y','N')" defaultValue="N">
                <constraints nullable="false"/>
            </column>
          <column name="RECOGNIZED_DETAIL" type="varchar(255)"/>
          <column name="REPORT_TO_ROLE" type="varchar(255)"/>
          <column name="FK_CLIENT_ID" type="int(10) unsigned"/>
          <column name="RM_NEXT_UPDATE" type="date"/>
          <column name="RM_VERIFIED" type="date"/>
          <column name="RM_VERIFIED_BY" type="varchar(50)"/>
        </createTable>

        <sql dbms="mysql,mariadb">ALTER TABLE X_REPORTING CHANGE COLUMN LAST_UPDATE
            LAST_UPDATE timestamp NOT NULL default CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP</sql>

        <createIndex tableName="X_REPORTING" indexName="LEGAL_MORAL">
          <column name="LEGAL_MORAL"/>
        </createIndex>
        <createIndex tableName="X_REPORTING" indexName="XR_SOURCE_ID">
          <column name="FK_SOURCE_ID"/>
        </createIndex>
        <modifySql dbms="h2">
             <replace replace="ENUM('L','M','V')" with="VARCHAR(1)"/>
             <replace replace="ENUM('Y','N')" with="VARCHAR(1)"/>
        </modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-34">
        <comment>Links spatial coverage and reporting obligation elements</comment>
        <createTable tableName="X_SPATIAL_LNK">
          <column name="PK_SPATIAL_LNK_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="FK_SPATIAL_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="FK_RO_ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="VOLUNTARY" type="enum('Y','N')" defaultValue="N"/>
        </createTable>
        <createIndex tableName="X_SPATIAL_LNK" indexName="XS_SPATIAL_ID">
          <column name="FK_SPATIAL_ID"/>
        </createIndex>
        <createIndex tableName="X_SPATIAL_LNK" indexName="XS_RO_ID">
          <column name="FK_RO_ID"/>
        </createIndex>
        <modifySql dbms="h2">
             <replace replace="ENUM('Y','N')" with="VARCHAR(1)"/>
        </modifySql>
   </changeSet>


    <changeSet author="roug" id="rev-35">
        <comment>Parameter unit types</comment>
        <createTable tableName="X_UNIT">
          <column name="PK_UNIT_ID" type="int(10) unsigned" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="UNIT_NAME" type="varchar(50)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="UNIT_HELP" type="text"/>
        </createTable>
   </changeSet>

    <changeSet author="roug" id="rev-37">
        <comment>Labels for names in T_ATTRIBUTE</comment>
        <createTable tableName="T_NAMELABEL">
          <column name="NAME" type="varchar(50)" defaultValue="">
                <constraints nullable="false" primaryKey="true"/>
            </column>
          <column name="LABEL" type="varchar(64)" defaultValue=""/>
        </createTable>
    </changeSet>

    <changeSet author="roug" id="rev-38">
        <comment>Ability to have random attributes on main objects</comment>
        <createTable tableName="T_ATTRIBUTE">
          <column name="ID" type="int(10) unsigned" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
          <column name="SCOPE" type="enum('obligations','instruments','clients','spatial')" defaultValue="obligations">
                <constraints nullable="false"/>
            </column>
          <column name="NAME" type="varchar(50)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="OBJECT" type="varchar(255)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="OBJECTLANG" type="varchar(10)" defaultValue="">
                <constraints nullable="false"/>
            </column>
          <column name="TYPE" type="enum('reference','string','integer','decimal','boolean','dateTime','date')" defaultValue="string"/>
          <column name="LINKTEXT" type="varchar(64)" defaultValue=""/>
       </createTable>
       <addPrimaryKey tableName="T_ATTRIBUTE" columnNames="ID,SCOPE,NAME,OBJECT,OBJECTLANG"/>
        <createIndex tableName="T_ATTRIBUTE" indexName="PREDICATE">
          <column name="NAME"/>
        </createIndex>
        <createIndex tableName="T_ATTRIBUTE" indexName="OBJECT">
          <column name="OBJECT"/>
        </createIndex>
       <addForeignKeyConstraint baseTableName="T_ATTRIBUTE" constraintName="T_ATTRIBUTE_ibfk_1"
           baseColumnNames="NAME" referencedTableName="T_NAMELABEL" referencedColumnNames="NAME"/>
       <modifySql dbms="h2">
             <replace replace="ENUM('obligations','instruments','clients','spatial')" with="VARCHAR(12)"/>
             <replace replace="ENUM('reference','string','integer','decimal','boolean','dateTime','date')" with="VARCHAR(10)"/>
        </modifySql>
    </changeSet>

  <changeSet id="rev-39" author="roug">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="authorities"/>
      </not>
    </preConditions>
    <createTable tableName="authorities">
          <column name="username" type="varchar(40)">
        <constraints nullable="false"/>
      </column>
          <column name="authority" type="varchar(255)"/>
    </createTable>
  </changeSet>

  <changeSet id="rev-40" author="roug">
    <preConditions onFail="MARK_RAN">
      <not>
        <tableExists tableName="users"/>
      </not>
    </preConditions>
    <createTable tableName="users">
          <column name="username" type="varchar(40)">
        <constraints unique="true"/>
      </column>
          <column name="password" type="varchar(40)"/>
          <column name="enabled" type="boolean"/>
    </createTable>
  </changeSet>

  <!-- Test data for ROD3 development site. Must use context="uat" -->
  <include file="uatdata/loaduatdata.xml"/>

  <changeSet author="santamik" id="rev-41">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="X_ACTIVITY"/>
    </preConditions>
    <comment>
      Refs #90026 Remove obsolete tables
    </comment>  
    <dropTable tableName="X_ACTIVITY" />  
  </changeSet>

  <changeSet author="santamik" id="rev-42">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="X_PARAMETER"/>
    </preConditions>
    <comment>
      Refs #90026 Remove obsolete tables
    </comment>  
    <dropTable tableName="X_PARAMETER" /> 
  </changeSet>

  <changeSet author="santamik" id="rev-43">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="X_PARAMETER_LNK"/>
    </preConditions>
    <comment>
      Refs #90026 Remove obsolete tables
    </comment>  
    <dropTable tableName="X_PARAMETER_LNK" /> 
  </changeSet>

  <changeSet author="santamik" id="rev-44">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="X_PARAM_GROUP"/>
    </preConditions>
    <comment>
      Refs #90026 Remove obsolete tables
    </comment>  
    <dropTable tableName="X_PARAM_GROUP" /> 
  </changeSet>

  <changeSet author="santamik" id="rev-45">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="X_REPORTING"/>
    </preConditions>
    <comment>
      Refs #90026 Remove obsolete tables
    </comment>  
    <dropTable tableName="X_REPORTING" /> 
  </changeSet>

  <changeSet author="santamik" id="rev-46">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="X_SPATIAL_LNK"/>
    </preConditions>
    <comment>
      Refs #90026 Remove obsolete tables
    </comment>  
    <dropTable tableName="X_SPATIAL_LNK" /> 
  </changeSet>

  <changeSet author="santamik" id="rev-47">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="X_UNIT"/>
    </preConditions>
    <comment>
      Refs #90026 Remove obsolete tables
    </comment>  
    <dropTable tableName="X_UNIT" />  
  </changeSet>  

  <changeSet author="santamik" id="rev-48">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_INDICATOR"/>
    </preConditions>  
    <comment>
      Refs #90918 Remove T_INDICATOR table
    </comment>
    <dropTable tableName="T_INDICATOR" />
  </changeSet>  
  
  <changeSet author="santamik" id="rev-49">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="X_CLIENT_LNK"/>
    </preConditions>
    <comment>
      Refs #90026 Remove obsolete tables
    </comment>  
    <dropTable tableName="X_CLIENT_LNK" />  
  </changeSet>  

  <changeSet author="santamik" id="rev-50">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="GEOGRAPHIC_SCOPE"/>
    </preConditions>  
    <comment>
      Refs #89744 Remove geographic scope
    </comment>  
    <dropColumn columnName="GEOGRAPHIC_SCOPE" tableName="T_SOURCE"/>  
  </changeSet>    
  
  <changeSet author="santamik" id="rev-51">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="DGENV_REVIEW"/>
    </preConditions>  
    <comment>
      Refs #89744 'DG Env' review of reporting theme' can be removed
    </comment>  
    <dropColumn columnName="DGENV_REVIEW" tableName="T_SOURCE"/>  
  </changeSet>     

  <changeSet author="santamik" id="rev-52">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="ALIAS"/>
    </preConditions>  
    <comment>
      Refs #89744 Short name must be mandatory
    </comment>  
    <sql>UPDATE T_SOURCE SET ALIAS = TITLE WHERE ALIAS IS NULL;</sql>
  </changeSet> 
  
  <changeSet author="santamik" id="rev-53">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="ALIAS"/>
    </preConditions>  
    <comment>
      Refs #89744 Short name must be mandatory
    </comment>  
    <addNotNullConstraint
            columnDataType="text"
            columnName="ALIAS"
            tableName="T_SOURCE"/>
  </changeSet> 
  
  <changeSet author="santamik" id="rev-54">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="DRAFT"/>
    </preConditions>  
    <comment>
      Refs #89744 Remove Draft
    </comment>  
    <dropColumn columnName="DRAFT" tableName="T_SOURCE"/>  
  </changeSet>   
  
  <changeSet author="santamik" id="rev-55">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
    </preConditions>  
    <comment>
      Refs #89744 Add Terminated column
    </comment>  
    <addColumn tableName="T_SOURCE">
        <column name="TERMINATED" type="enum('Y','N')"/>
    </addColumn>
    <modifySql dbms="h2">
    	<replace replace="ENUM('Y', 'N')" with="VARCHAR(1)"/>
	</modifySql>
</changeSet>  

  <changeSet author="santamik" id="rev-56">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="DPSIR_D"/>      
    </preConditions>  
    <comment>
      Refs #89743 Remove DPSIR_D
    </comment>  
    <dropColumn columnName="DPSIR_D" tableName="T_OBLIGATION"/>
  </changeSet>   
 
  <changeSet author="santamik" id="rev-57">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="DPSIR_P"/>      
    </preConditions>  
    <comment>
      Refs #89743 Remove DPSIR_P
    </comment>  
    <dropColumn columnName="DPSIR_P" tableName="T_OBLIGATION"/>
  </changeSet>  
 
  <changeSet author="santamik" id="rev-58">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="DPSIR_S"/>      
    </preConditions>  
    <comment>
      Refs #89743 Remove DPSIR_S
    </comment>  
    <dropColumn columnName="DPSIR_S" tableName="T_OBLIGATION"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-59">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="DPSIR_I"/>      
    </preConditions>  
    <comment>
      Refs #89743 Remove DPSIR_I
    </comment>  
    <dropColumn columnName="DPSIR_I" tableName="T_OBLIGATION"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-60">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="DPSIR_R"/>      
    </preConditions>  
    <comment>
      Refs #89743 Remove DPSIR_R
    </comment>  
    <dropColumn columnName="DPSIR_R" tableName="T_OBLIGATION"/>
  </changeSet>     

  <changeSet author="santamik" id="rev-61">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_INFO_LNK"/>
    </preConditions>
    <comment>
      Refs #89743 'Type of info reported' can be reported
    </comment>  
    <dropTable tableName="T_INFO_LNK" />  
  </changeSet> 

  <changeSet author="santamik" id="rev-62">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="LEGAL_MORAL"/>      
    </preConditions>  
    <comment>
      Refs #89743 Remove 'Obligation type'
    </comment>  
    <dropColumn columnName="LEGAL_MORAL" tableName="T_OBLIGATION"/>
  </changeSet>    

  <changeSet author="santamik" id="rev-63">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="PARAMETERS"/>      
    </preConditions>  
    <comment>
      Refs #89741 Remove "Parameters" from the Obligations
    </comment>  
    <dropColumn columnName="PARAMETERS" tableName="T_OBLIGATION"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-64">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="RM_VERIFIED"/>      
    </preConditions>  
    <comment>
      Refs #89742 Remove "Record management" section for obligations and instruments
    </comment>  
    <dropColumn columnName="RM_VERIFIED" tableName="T_OBLIGATION"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-65">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="RM_VERIFIED_BY"/>      
    </preConditions>  
    <comment>
      Refs #89742 Remove "Record management" section for obligations and instruments
    </comment>  
    <dropColumn columnName="RM_VERIFIED_BY" tableName="T_OBLIGATION"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-66">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="RM_NEXT_UPDATE"/>      
    </preConditions>  
    <comment>
      Refs #89742 Remove "Record management" section for obligations and instruments
    </comment>  
    <dropColumn columnName="RM_NEXT_UPDATE" tableName="T_OBLIGATION"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-67">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="VALIDATED_BY"/>      
    </preConditions>  
    <comment>
      Refs #89742 Remove "Record management" section for obligations and instruments
    </comment>  
    <dropColumn columnName="VALIDATED_BY" tableName="T_OBLIGATION"/>
  </changeSet> 

  <changeSet author="santamik" id="rev-68">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="RM_VERIFIED"/>      
    </preConditions>  
    <comment>
      Refs #89742 Remove "Record management" section for obligations and instruments
    </comment>  
    <dropColumn columnName="RM_VERIFIED" tableName="T_SOURCE"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-69">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="RM_VERIFIED_BY"/>      
    </preConditions>  
    <comment>
      Refs #89742 Remove "Record management" section for obligations and instruments
    </comment>  
    <dropColumn columnName="RM_VERIFIED_BY" tableName="T_SOURCE"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-70">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="RM_NEXT_UPDATE"/>      
    </preConditions>  
    <comment>
      Refs #89742 Remove "Record management" section for obligations and instruments
    </comment>  
    <dropColumn columnName="RM_NEXT_UPDATE" tableName="T_SOURCE"/>
  </changeSet>  

  <changeSet author="santamik" id="rev-71">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
      <columnExists tableName="T_SOURCE" columnName="RM_VALIDATED_BY"/>      
    </preConditions>  
    <comment>
      Refs #89742 Remove "Record management" section for obligations and instruments
    </comment>  
    <dropColumn columnName="RM_VALIDATED_BY" tableName="T_SOURCE"/>
  </changeSet> 

  <changeSet author="santamik" id="rev-72">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="FK_CLIENT_ID"/>      
    </preConditions>  
    <comment>
      Refs #89743 Remove "FK_CLIENT_ID" from the Obligations
    </comment>  
    <dropColumn columnName="FK_CLIENT_ID " tableName="T_OBLIGATION"/>
  </changeSet> 

  <changeSet author="santamik" id="rev-73">
    <comment>
      Refs #90026 New table for client-obligation relation
    </comment>    
    <createTable tableName="T_CLIENT_OBLIGATION_LNK">
      <column defaultValueNumeric="0" name="FK_CLIENT_ID" type="INT(10) unsigned">
        <constraints nullable="false" />
      </column>
      <column defaultValueNumeric="0" name="FK_RA_ID" type="INT(10) unsigned">
        <constraints nullable="false" />
      </column>
      <column defaultValue="M" name="STATUS" type="enum('M','C')">
        <constraints nullable="false" />
      </column>
    </createTable>
    <addPrimaryKey tableName="T_CLIENT_OBLIGATION_LNK" columnNames="FK_CLIENT_ID,FK_RA_ID,STATUS"/>
    <modifySql dbms="h2">
    	<replace replace="ENUM('M', 'C')" with="VARCHAR(1)"/>
	</modifySql>      
  </changeSet>

  <changeSet author="santamik" id="rev-74">
    <comment>
      Refs #90026 New table for client-instrument relation
    </comment>      
    <createTable tableName="T_CLIENT_SOURCE_LNK">
      <column defaultValueNumeric="0" name="FK_CLIENT_ID" type="INT(10) unsigned">
        <constraints nullable="false" />
      </column>
      <column defaultValueNumeric="0" name="FK_SOURCE_ID" type="INT(10) unsigned">
        <constraints nullable="false" />
      </column>
      <column defaultValue="M" name="STATUS" type="enum('M','C')">
        <constraints nullable="false" />
      </column>
      
    </createTable>
    <addPrimaryKey tableName="T_CLIENT_SOURCE_LNK" columnNames="FK_CLIENT_ID,FK_SOURCE_ID,STATUS"/>
    <modifySql dbms="h2">
    	<replace replace="ENUM('M', 'C')" with="VARCHAR(1)"/>
	</modifySql>
  </changeSet>  
  <changeSet author="santamik" id="rev-75">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_CLIENT_LNK"/>     
      <tableExists tableName="T_CLIENT_OBLIGATION_LNK"/>      
    </preConditions> 
     <comment>
      Refs #90026
    </comment>  
    <sql>INSERT INTO T_CLIENT_OBLIGATION_LNK (FK_CLIENT_ID, FK_RA_ID, STATUS)
      SELECT FK_CLIENT_ID, FK_OBJECT_ID, STATUS
      FROM T_CLIENT_LNK
      WHERE TYPE = 'A'</sql>
  </changeSet>  

  <changeSet author="santamik" id="rev-76">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_CLIENT_LNK"/>     
      <tableExists tableName="T_CLIENT_SOURCE_LNK"/>      
    </preConditions> 
     <comment>
      Refs #90026
    </comment>  
    <sql>INSERT INTO T_CLIENT_SOURCE_LNK (FK_CLIENT_ID, FK_SOURCE_ID, STATUS)
      SELECT FK_CLIENT_ID, FK_OBJECT_ID, STATUS
      FROM T_CLIENT_LNK
      WHERE TYPE = 'S'</sql>
  </changeSet>   
  <changeSet author="santamik" id="rev-77">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_CLIENT_LNK"/>
    </preConditions>
    <comment>
      Refs #90026 Delete T_CLIENT_LNK table
    </comment>  
    <dropTable tableName="T_CLIENT_LNK" />  
  </changeSet>
  <changeSet author="santamik" id="rev-78">
      <comment>Refs #89743 Relations between obligations</comment>
      <createTable tableName="T_OBLIGATION_RELATION">
          <column name="FK_RA_ID" type="INT(10) unsigned">
              <constraints nullable="false"/>
          </column>
          <column name="RELATION" type="enum('replaces','is-replaced-by','see-also', 'same-as')">
              <constraints nullable="false"/>            
          </column>
          <column name="FK_RA_ID2" type="INT(10) unsigned">
              <constraints nullable="false"/>
          </column>
      </createTable>
      <addPrimaryKey tableName="T_OBLIGATION_RELATION" columnNames="FK_RA_ID,FK_RA_ID2"/>
  </changeSet>       
  <changeSet author="santamik" id="rev-79">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="overlap_url"/>      
      <tableExists tableName="T_OBLIGATION_RELATION"/>      
    </preConditions>  
    <comment>
      Refs #89743 Add data from overlap_url as 'see-also'
    </comment>  
    <sql>INSERT INTO T_OBLIGATION_RELATION (FK_RA_ID, RELATION, FK_RA_ID2)
      SELECT PK_RA_ID,'see-also',replace(overlap_url, 'http://rod.eionet.europa.eu/obligations/', '')
      FROM T_OBLIGATION
      WHERE OVERLAP_URL like 'http://rod.eionet.europa.eu/obligations/%'</sql>
  </changeSet>  
  <changeSet author="santamik" id="rev-80">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_OBLIGATION"/>
      <columnExists tableName="T_OBLIGATION" columnName="OVERLAP_URL"/>      
    </preConditions>  
    <comment>
      Refs #89743 Remove OVERLAP_URL
    </comment>  
    <dropColumn columnName="OVERLAP_URL" tableName="T_OBLIGATION"/>
  </changeSet>  
  <changeSet author="santamik" id="rev-81">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_HISTORY"/>
    </preConditions>
    <comment>
      Refs #8970 Delete T_HISTORY table
    </comment>  
    <dropTable tableName="T_HISTORY" />  
  </changeSet>   
  <changeSet author="santamik" id="rev-82">
    <preConditions onFail="MARK_RAN">
      <tableExists tableName="T_SOURCE"/>
    </preConditions>  
    <comment>
      Rename terminated column
    </comment>  
    <renameColumn  
      columnDataType="enum('Y','N')"
      newColumnName="TERMINATE"
      oldColumnName="TERMINATED"
      tableName="T_SOURCE"/>
  </changeSet>    
 <changeSet author="santamik" id="rev-83" dbms="h2">
    <modifyDataType 
            columnName="VALUE"
            newDataType="TEXT"
            tableName="T_UNDO"/> 
  
 </changeSet>
    <changeSet id="rev-84a" author="ivascu" dbms="mysql,mariadb">
        <comment>Preparing for foreign keys</comment>
        <sql>
            alter table T_CLIENT MODIFY COLUMN PK_CLIENT_ID int(10) auto_increment;
            alter table T_CLIENT_OBLIGATION_LNK MODIFY COLUMN FK_CLIENT_ID int(10);
            alter table T_CLIENT_SOURCE_LNK MODIFY COLUMN FK_CLIENT_ID int(10);
            alter table T_CLIENT_SOURCE_LNK MODIFY COLUMN FK_SOURCE_ID int(10);
            alter table T_CLIENT_OBLIGATION_LNK MODIFY COLUMN FK_RA_ID int(10);
            alter table T_OBLIGATION MODIFY COLUMN PK_RA_ID int(10) auto_increment;
            alter table T_DELIVERY MODIFY COLUMN FK_RA_ID int(10);
            alter table T_DELIVERY MODIFY COLUMN FK_SPATIAL_ID int(10);
            alter table T_SPATIAL MODIFY COLUMN PK_SPATIAL_ID int(10) auto_increment;
            alter table T_SPATIAL_HISTORY MODIFY COLUMN FK_SPATIAL_ID int(10);
            alter table T_SPATIAL_HISTORY MODIFY COLUMN FK_RA_ID int(10);
            alter table T_SOURCE_TYPE MODIFY COLUMN PK_TYPE_ID int(10) auto_increment;
            alter table T_SOURCE MODIFY COLUMN FK_TYPE_ID int(10);
            alter table T_OBLIGATION_RELATION MODIFY COLUMN FK_RA_ID int(10);
            alter table T_OBLIGATION_RELATION MODIFY COLUMN FK_RA_ID2 int(10);
            alter table T_RASPATIAL_LNK MODIFY COLUMN FK_RA_ID int(10);
            alter table T_RASPATIAL_LNK MODIFY COLUMN FK_SPATIAL_ID int(10);
            alter table T_HISTORIC_DEADLINES MODIFY COLUMN FK_RA_ID int(10);
            alter table T_OBLIGATION MODIFY COLUMN FK_SOURCE_ID int(10);
            alter table T_RAISSUE_LNK MODIFY COLUMN FK_ISSUE_ID int(10);
            alter table T_RAISSUE_LNK MODIFY COLUMN FK_RA_ID int(10);
            alter table T_ISSUE MODIFY COLUMN PK_ISSUE_ID int(10) auto_increment;
            alter table T_ISSUE MODIFY COLUMN FK_DD_GUID int(10);
            alter table T_SOURCE MODIFY COLUMN PK_SOURCE_ID int(10) auto_increment;
            alter table T_SOURCE_CLASS MODIFY COLUMN PK_CLASS_ID int(10) auto_increment;

        </sql>
    </changeSet>
    <changeSet id="rev-84b" author="ivascu" dbms="mysql,mariadb">
        <comment>Changed DB engine to InnoDB for all tables</comment>
        <sql>
            alter table ACL_ROWS engine=InnoDB;
            alter table ACLS engine=InnoDB;
            alter table authorities engine=InnoDB;
            alter table DATABASECHANGELOG engine=InnoDB;
            alter table DATABASECHANGELOGLOCK engine=InnoDB;
            alter table HLP_AREA engine=InnoDB;
            alter table HLP_SCREEN engine=InnoDB;
            alter table T_ATTRIBUTE engine=InnoDB;
            alter table T_CLIENT engine=InnoDB;
            alter table T_CLIENT_OBLIGATION_LNK engine=InnoDB;
            alter table T_CLIENT_SOURCE_LNK engine=InnoDB;
            alter table T_DELIVERY engine=InnoDB;
            alter table T_HELP engine=InnoDB;
            alter table T_HISTORIC_DEADLINES engine=InnoDB;
            alter table T_ISSUE engine=InnoDB;
            alter table T_LOOKUP engine=InnoDB;
            alter table T_NAMELABEL engine=InnoDB;
            alter table T_OBLIGATION engine=InnoDB;
            alter table T_OBLIGATION_RELATION engine=InnoDB;
            alter table T_RAISSUE_LNK engine=InnoDB;
            alter table T_RASPATIAL_LNK engine=InnoDB;
            alter table T_ROLE engine=InnoDB;
            alter table T_SOURCE engine=InnoDB;
            alter table T_SOURCE_CLASS engine=InnoDB;
            alter table T_SOURCE_LNK engine=InnoDB;
            alter table T_SOURCE_TYPE engine=InnoDB;
            alter table T_SPATIAL engine=InnoDB;
            alter table T_SPATIAL_HISTORY engine=InnoDB;
            alter table T_UNDO engine=InnoDB;
            alter table users engine=InnoDB;
        </sql>
    </changeSet>
    <changeSet id="rev-84c" author="ivascu">
        <comment>Cleanup to solve FK issues</comment>
        <sql>
            delete from T_CLIENT_SOURCE_LNK where FK_CLIENT_ID=0;
            delete from T_DELIVERY where FK_RA_ID=70;
            delete from T_SPATIAL_HISTORY where not exists (select 1 from T_OBLIGATION where PK_RA_ID = FK_RA_ID);
            delete from T_OBLIGATION_RELATION where not exists (select 1 from T_OBLIGATION where FK_RA_ID2= PK_RA_ID);
            insert into T_SOURCE(PK_SOURCE_ID, TITLE, ALIAS, SOURCE_CODE, LEGAL_NAME) values (1, 'Unknown', 'Unknown', 'Unknown','Unknown');
            update T_OBLIGATION set fk_source_id=1 where fk_source_id=0;
        </sql>
    </changeSet>
    <changeSet id="rev-84" author="ivascu">
        <comment>Adding foreign keys</comment>
       <addForeignKeyConstraint baseTableName="T_CLIENT_OBLIGATION_LNK" constraintName="T_CLIENT_OB_CLIENT_FK"
           baseColumnNames="FK_CLIENT_ID" referencedTableName="T_CLIENT" referencedColumnNames="PK_CLIENT_ID" onDelete="CASCADE"/>
       <addForeignKeyConstraint baseTableName="T_CLIENT_SOURCE_LNK" constraintName="T_CLIENT_SRC_CLIENT_FK"
           baseColumnNames="FK_CLIENT_ID" referencedTableName="T_CLIENT" referencedColumnNames="PK_CLIENT_ID" onDelete="CASCADE"/>
       <addForeignKeyConstraint baseTableName="T_CLIENT_OBLIGATION_LNK" constraintName="T_CLIENT_OB_RA_FK"
           baseColumnNames="FK_RA_ID" referencedTableName="T_OBLIGATION" referencedColumnNames="PK_RA_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_CLIENT_SOURCE_LNK" constraintName="T_CLIENT_SRC_SRC_FK"
           baseColumnNames="FK_SOURCE_ID" referencedTableName="T_SOURCE" referencedColumnNames="PK_SOURCE_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_DELIVERY" constraintName="T_DELIVERY_RA_FK"
           baseColumnNames="FK_RA_ID" referencedTableName="T_OBLIGATION" referencedColumnNames="PK_RA_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_DELIVERY" constraintName="T_DELIVERY_SP_FK"
           baseColumnNames="FK_SPATIAL_ID" referencedTableName="T_SPATIAL" referencedColumnNames="PK_SPATIAL_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_SPATIAL_HISTORY" constraintName="T_SP_H_SP_FK"
           baseColumnNames="FK_SPATIAL_ID" referencedTableName="T_SPATIAL" referencedColumnNames="PK_SPATIAL_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_SPATIAL_HISTORY" constraintName="T_SP_H_RA_FK"
           baseColumnNames="FK_RA_ID" referencedTableName="T_OBLIGATION" referencedColumnNames="PK_RA_ID" onDelete="CASCADE"/>
<!--        <addForeignKeyConstraint baseTableName="T_SOURCE" constraintName="T_SRC_TYPE_FK"-->
<!--           baseColumnNames="FK_TYPE_ID" referencedTableName="T_SOURCE_TYPE" referencedColumnNames="PK_TYPE_ID" onDelete="CASCADE"/>-->

        <addForeignKeyConstraint baseTableName="T_OBLIGATION_RELATION" constraintName="T_OB_REL_RA1_FK"
           baseColumnNames="FK_RA_ID" referencedTableName="T_OBLIGATION" referencedColumnNames="PK_RA_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_OBLIGATION_RELATION" constraintName="T_OB_REL_RA2_FK"
           baseColumnNames="FK_RA_ID2" referencedTableName="T_OBLIGATION" referencedColumnNames="PK_RA_ID" onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="T_RASPATIAL_LNK" constraintName="T_RASP_LINK_RA_FK"
           baseColumnNames="FK_RA_ID" referencedTableName="T_OBLIGATION" referencedColumnNames="PK_RA_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_RASPATIAL_LNK" constraintName="T_RASP_LINK_SP_FK"
           baseColumnNames="FK_SPATIAL_ID" referencedTableName="T_SPATIAL" referencedColumnNames="PK_SPATIAL_ID" onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="T_HISTORIC_DEADLINES" constraintName="T_HISTD_RA_FK"
           baseColumnNames="FK_RA_ID" referencedTableName="T_OBLIGATION" referencedColumnNames="PK_RA_ID" onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="T_OBLIGATION" constraintName="T_OB_SRC_FK"
           baseColumnNames="FK_SOURCE_ID" referencedTableName="T_SOURCE" referencedColumnNames="PK_SOURCE_ID" onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="T_RAISSUE_LNK" constraintName="T_ISSUE_LNK_ISSUE_FK"
           baseColumnNames="FK_ISSUE_ID" referencedTableName="T_ISSUE" referencedColumnNames="PK_ISSUE_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_RAISSUE_LNK" constraintName="T_ISSUE_LNK_RA_FK"
           baseColumnNames="FK_RA_ID" referencedTableName="T_OBLIGATION" referencedColumnNames="PK_RA_ID" onDelete="CASCADE"/>

    </changeSet>
    <changeSet id="rev-85" author="ivascu">
        <comment>Setting the fk_type_id as optional, as the code doesn't set it</comment>
        <dropNotNullConstraint  tableName="T_SOURCE" columnName="FK_TYPE_ID" columnDataType="int(10) unsigned"/>
    </changeSet>
    <changeSet id="rev-86" author="ivascu" dbms="mysql,mariadb">
        <comment>Other incorrect table keys</comment>
        <sql>
            alter table T_SOURCE_LNK MODIFY COLUMN PK_SOURCE_LNK_ID int(10) auto_increment;
            alter table T_SOURCE_LNK MODIFY COLUMN FK_SOURCE_CHILD_ID int(10);
            alter table T_SOURCE_LNK MODIFY COLUMN FK_SOURCE_PARENT_ID int(10);
        </sql>
    </changeSet>
    <changeSet id="rev-87" author="ivascu">
        <comment>Adding forgotten FKs, with cleanup of old data</comment>

        <sql>
            delete from T_SOURCE_LNK where not exists (select 1 from T_SOURCE where PK_SOURCE_ID = FK_SOURCE_CHILD_ID);
            delete from T_SOURCE_LNK where not exists (select 1 from T_SOURCE where PK_SOURCE_ID = FK_SOURCE_PARENT_ID);
        </sql>
        <addForeignKeyConstraint baseTableName="T_SOURCE_LNK" baseColumnNames="FK_SOURCE_CHILD_ID" constraintName="T_SOURCE_CHILD_FK" referencedTableName="T_SOURCE" referencedColumnNames="PK_SOURCE_ID" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="T_SOURCE_LNK" baseColumnNames="FK_SOURCE_PARENT_ID" constraintName="T_SOURCE_PARENT_FK" referencedTableName="T_SOURCE" referencedColumnNames="PK_SOURCE_ID" onDelete="CASCADE"/>
    </changeSet>
    <changeSet id="rev-88" author="ivascu">
        <comment>Moving the users</comment>
        <sql>
            insert into users(username, password, enabled)  select distinct owner, '', 1 from ACLS a, ACL_ROWS ar where a.acl_id = ar.acl_id and owner is not null and owner not in ('') and status=1 and not exists (select 1 from users where owner=username);
            insert into authorities(username, authority) select distinct owner, 'ROLE_EDITOR' from ACLS a, ACL_ROWS ar where a.acl_id = ar.acl_id and owner is not null and owner not in ('') and status=1 and not exists (select 1 from authorities b where b.username=owner and b.authority='ROLE_EDITOR');
        </sql>
        <dropTable tableName="ACLS"/>
        <dropTable tableName="ACL_ROWS"/>

    </changeSet>

    <changeSet id="rev-89" author="ivascu">
        <comment>Reverting some of the FK changes as the DB is not normalized and the T_SOURCE_LNK table is actually used with multiple tables (T_SOURCE + T_SOURCE_CLASS)</comment>
        <dropForeignKeyConstraint baseTableName="T_SOURCE_LNK" constraintName="T_SOURCE_CHILD_FK"/>
        <dropForeignKeyConstraint baseTableName="T_SOURCE_LNK" constraintName="T_SOURCE_PARENT_FK"/>
        <sqlFile path="db/restore_t_source_lnk.sql"/>
    </changeSet>
    <changeSet id="rev-90" author="ivascu">
        <comment>Do not delete instruments that have obligations.</comment>
        <dropForeignKeyConstraint baseTableName="T_OBLIGATION" constraintName="T_OB_SRC_FK"/>
        <addForeignKeyConstraint baseTableName="T_OBLIGATION" constraintName="T_OB_SRC_FK"
                                 baseColumnNames="FK_SOURCE_ID" referencedTableName="T_SOURCE" referencedColumnNames="PK_SOURCE_ID" onDelete="RESTRICT"/>

    </changeSet>
    <changeSet id="rev-91" author="alfaredu">
      <comment>Add new fields in obligations</comment>
      <sql>
          alter table T_OBLIGATION ADD column DATA_STEWARD varchar(255);
          alter table T_OBLIGATION ADD column DATA_CUSTODIAN varchar(255);
          alter table T_OBLIGATION ADD column HELPDESK_MAIL varchar(255);
          alter table T_OBLIGATION ADD column TYPE_INFORMATION varchar(255);
          alter table T_OBLIGATION ADD column PRODUCT_KEYWORD varchar(255);
          alter table T_OBLIGATION ADD column PROCEDURE_DOCUMENTATION text;
          alter table T_OBLIGATION ADD column EEA_STRATEGIC_AREA varchar(50);
          alter table T_OBLIGATION ADD column EEA_PROGRAMME varchar(50);
          alter table T_OBLIGATION ADD column EEA_GROUP varchar(50);
      </sql>
  </changeSet>
</databaseChangeLog>
